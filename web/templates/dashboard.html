<!DOCTYPE html>
<meta charset="utf-8" />
<html>
    <head>
        <!-- TODO: Make sure these are internally served up -->
        <!-- CSS Stylesheets -->
        <link type="text/css" rel="stylesheet" href="//golden-layout.com/files/latest/css/goldenlayout-base.css" />
        <link type="text/css" rel="stylesheet" href="//golden-layout.com/files/latest/css/goldenlayout-dark-theme.css" />

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

        <!-- Javascript Imports -->
        <script type="text/javascript" src="//code.jquery.com/jquery-1.11.1.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="//golden-layout.com/files/latest/js/goldenlayout.min.js"></script>

        <!-- JSON Editor -->
        <script type="text/javascript" src="/static/js/jsoneditor.min.js"></script>

        <!-- Note: The order of these headers affects the coloring of the depth feed. Don't change this!-->
        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <style>
            body .lm_content {
              overflow: scroll;
            }

            tr:hover { background-color: #16242d; }
            ::-webkit-scrollbar {
                width: 0px;  /* remove scrollbar space */
                height: 0px;
                background: transparent;  /* optional: just make scrollbar invisible */
            }

            .nav-tabs>li {
            }
            .nav-tabs>li>a {
                border-radius: 0px;
                color: #ced2d5;
            }
            .nav-tabs {
                border-bottom: 0px;
            }
            .nav-tabs>li.active>a {
                color: #555;
            }
            .nav-tabs>li:hover>a {
                color: #555;
            }

            #market_buy_tab>a {
                border: 0px;
            }
            #market_buy_tab>a:hover {
                color: #ced2d5;
                background-color: #27ae60;
                border: 0px;
            }
            #market_sell_tab>a {
                border: 0px;
            }
            #market_sell_tab>a:hover {
                color: black;
                background-color: #c0392b;
                border: 0px;
            }

            .messageCounter {
                position: absolute;
                right: -75px;
                top: -0px;
                color:#fff;
                font-weight: bold;
                z-index: 4;
                padding: 2px 5px;
            }
            .tab-btn-first {
                position: absolute;
                right: -30px;
                top: -0px;
                font-weight: bold;
                z-index: 4;
                border-radius: 50px;
            }
            .smfont {
                font-size: 10px;
            }

            /* overriding styling in the json editor */
            .editor > div > h3 > span {
                color: #fff;
            }
            h3 {
                font-size: 14px;
            }
            h3 > div >.btn-default {
                padding: 2px 8px;
                font-size: 12px;
                line-height: 1.5;
                border-radius: 3px;
            }

        </style>
    </head>
    <body>
    </body>
    <script src="/static/js/depth_feed.js"></script>
    <script>
        // Utility Functions. Move to seperate js file
        function getWidth() {
            if (self.innerWidth) { return self.innerWidth; }
            if (document.documentElement && document.documentElement.clientWidth) {
                return document.documentElement.clientWidth;
            }
            if (document.body) { return document.body.clientWidth; }
        }
        function getHeight() {
            if (self.innerHeight) { return self.innerHeight; }
            if (document.documentElement && document.documentElement.clientHeight) {
                return document.documentElement.clientHeight;
            }
            if (document.body) { return document.body.clientHeight; }
        }

        // Define the layout configuration here
        // Compute depth feed width
        var feed_depth = 10;
        var row_size = 14; // pixels
        var base_measurements = { 'depth_feed': {'width': 450, 'height': (2*feed_depth+1)*row_size }, 'trade_actions': {'width': 230} };

        // TODO: define the width and height of the config below in a different struct
        // Defines the initial layout of the Dashboard
        var config = {
            content: [{
                type: 'row',
                content:[
                {
                    type: 'component',
                    componentName: 'trade_actions',
                    componentState: { },
                    title: 'Trade Actions',
                    width: Math.ceil((base_measurements.trade_actions.width/getWidth())*100)
                },{
                    type: 'column',
                    content: [{
                        type: 'component',
                        componentName: 'depth_feed',
                        componentState: { },
                        title: 'Depth Feed',
                        height: Math.ceil(((base_measurements.depth_feed.height + 60)/getHeight())*100)
                    }, {
                        type: 'component',
                        componentName: 'fills',
                        componentState: { },
                        title: 'Fills'
                    }, {
                        type: 'component',
                        componentName: 'messaging',
                        componentState: { },
                        title: 'Messaging'

                    }],
                    width: Math.ceil((base_measurements.depth_feed.width/getWidth())*100),
                },{
                    type: 'row',
                    content:[{
                        type: 'column',
                        content:[
                        {
                            type: 'component',
                            componentName: 'trade_history',
                            componentState: { },
                            title: 'Trade History',
                        },{
                            type: 'component',
                            componentName: 'signals',
                            componentState: { },
                            title: 'Signals'
                        }],
                        width: Math.ceil((355/getWidth())*100)
                    },{
                        type: 'column',
                        content:[
                        {
                            type: 'component',
                            componentName: 'open_orders',
                            componentState: { },
                            title: 'Open Orders'
                        },
                        {
                            type: 'stack',
                            content: [{
                                type: 'component',
                                componentName: 'anchor_strategy',
                                componentState: { },
                                title: 'Anchor Strategy'
                            },
                            {
                                type: 'component',
                                componentName: 'signals',
                                componentState: { },
                                title: 'signals'
                            }]
                        }
                        ]
                    }]
                }]
            }]
        };

        var goldenDash, savedState = localStorage.getItem('savedState');

        // Try to retrieve dashboard from any saved state first
        if( savedState !== null ) {
            goldenDash = new GoldenLayout(JSON.parse(savedState));
        } else {
            goldenDash = new GoldenLayout(config );
        }

        var tradeActionsComponent = function(container, state) {
            // Check for local storage
            if (!typeof window.localStorage) {
                return;
            }

            var tab_btn_container = $('<div class="tab-btn-first"></div>');
            var refresh_button = $('<button class="btn btn-default btn-xs smfont" title="Refresh"><span class="glyphicon glyphicon-transfer"></span></button>');
            refresh_button.click(
                function() {
                    goldenDash.eventHub.emit('click_trader_message', '{"admin": "GetBalance"}');
                }
            );
            tab_btn_container.append(refresh_button);

            // Add the refresh button whenever a tab is created
            container.on( 'tab', function( tab ){
                tab.element.append( tab_btn_container );
            });


            var onSocketOpen =
                function (socket_name) {
                    $("#socket_connection_status").css('display', 'none');
                };
            var onSocketClosed =
                function (socket_name) {
                    $('#socket_connection_status').css('display', 'block');
                    const msg = 'Socket ['+socket_name+'] disconnected!';
                    $("#socket_connection_status").text(msg);
                };
            goldenDash.eventHub.on('socket_open', onSocketOpen);
            goldenDash.eventHub.on('socket_closed', onSocketClosed);

            // TODO: Refactor this part into smaller HTML chunks
            container.getElement().append(
                '<div class="row" style="color: #ced2d5; background-color: #1e2b34; font-size: 10px; font-family: opensans, sans-serif; -webkit-font-smoothing: antialiasing; margin: 0px">'+
                '    <div class="alert alert-danger" id="socket_connection_status" style="padding: 0px 5px 0px 5px; margin: 10px 10px 10px 10px; display: none; border-radius: 0px;" role="alert"></div>'+
                '    <div class="col-md-4 col-xs-6 follow line" align="right">'+
                '        <h6><span>Available</span> <br/> <span>Held</span> <br/> <span>Currency</span> </h6>'+
                '    </div>'+
                '    <div class="col-md-4 col-xs-6 follow line" align="left">'+
                '        <h6><span id="quoted_available">0.00</span> <br/> <span id="quoted_hold">0.00</span> <br/> <span><b>USD</b></span> </h6>'+
                '    </div>'+
                '    <div class="col-md-4 col-xs-6 follow line" align="left">'+
                '        <h6><span id="base_available">0.000000</span> <br/> <span id="base_hold">0.00</span> <br/> <span><b name="BASE_CURRENCY"></b></span></h6>'+
                '    </div>'+
                '    <div class="col-md-5 col-xs-6 follow line" align="right">'+
                '        <h6><b><span>Total Value</span></b></h6>'+
                '    </div>'+
                '    <div class="col-md-7 col-xs-6 follow line" align="left">'+
                '        <h6><span id="account_value">0.00</span> <span><b>USD</b></span> </h6>'+
                '    </div>'+
                '</div>'+
                '<div class="row" style="color: #ced2d5; background-color: #1e2b34; font-size: 10px; font-family: opensans, sans-serif; -webkit-font-smoothing: antialiasing; margin: 0px; padding: 20px 0px 0px 0px; height: 100%;">'+
                '    <div>'+
                '        <div id="limit" class="tab-pane fade in active">'+
                '            <div class="input-group" style=" margin-left: 5px; margin-right: 5px; margin-top: 10px;">'+
                '                <span class="input-group-addon" style="font-size: 11px; font-weight: bold;" id="basic-addon1">Amount</span>'+
                '                <input id="limit_amount" type="number" step="0.01" class="form-control" style="font-size: 11px;" placeholder="0.000000" value="0.01" aria-describedby="basic-addon1">'+
                '                <span class="input-group-addon" style="font-size: 11px; font-weight: bold;" id="basic-addon1" name="BASE_CURRENCY"></span>'+
                '            </div>'+
                '            <div class="input-group" style=" margin-left: 5px; margin-right: 5px; margin-top: 10px;">'+
                '                <span class="input-group-addon" style="font-size: 11px; font-weight: bold;" id="basic-addon1">At Price</span>'+
                '                <input id="limit_price" type="number" step="0.01" class="form-control" style="font-size: 11px;" placeholder="0.000000" value="100.00" aria-describedby="basic-addon1">'+
                '                <span class="input-group-addon" style="font-size: 11px; font-weight: bold;" id="basic-addon1">USD</span>'+
                '            </div>'+
                '            <div class="input-group" style=" margin-left: 10px; margin-right: 10px; margin-top: 10px; font-size: 12px; font-weight: bold;" id="limit_tif">'+
                '                <label class="radio-inline">'+
                '                    <input type="radio" name="limit_tif_radio" id="tif1" value="GTC" checked="checked">GTC'+
                '                </label>'+
                '                <label class="radio-inline">'+
                '                    <input type="radio" name="limit_tif_radio" id="tif2" value="IOC">IOC'+
                '                </label>'+
                '                <label class="radio-inline">'+
                '                    <input type="radio" name="limit_tif_radio" id="tif3" value="GTT" disabled>GTT'+
                '                </label>'+
                '                <label class="radio-inline">'+
                '                    <input type="radio" name="limit_tif_radio" id="tif4" value="FOK" disabled>FOK'+
                '                </label>'+
                '            </div>'+
                '            <div class="input-group" style=" margin-left: 62px; margin-right: 62px; margin-top: 10px; font-size: 12px; font-weight: bold;" id="limit_side">'+
                '                <label class="radio-inline">'+
                '                    <input type="radio" name="limit_radio_side" id="Side1" value="BUY" checked="checked">BUY'+
                '                </label>'+
                '                <label class="radio-inline">'+
                '                    <input type="radio" name="limit_radio_side" id="Side2" value="SELL">SELL'+
                '                </label>'+
                '            </div>'+
                '            <div style="margin-left: 10px; margin-right: 10px; margin-top: 10px;">'+
                '                <button type="button" id="limit_order_button" style="font-weight: bold" class="btn btn-block btn-primary btn-sm">ORDER</button>'+
                '            </div>'+
                '        </div>'+
                '    </div>'+
                '    <div class="btn-group btn-group-justified" role="group" aria-label="Cancel Buttons" style="margin: 10px 0px 0px 10px; padding-right: 20px;">'+
                '        <a type="button" id="cancel_session" style="font-weight: bold; font-size: 10px;" class="btn btn-warning btn-sm">CANCEL SESSION</a>'+
                '        <a type="button" id="cancel_all" style="font-weight: bold; font-size: 10px;" class="btn btn-danger btn-sm">CANCEL ALL</a>'+
                '    </div>'+
                '</div>'+
                '<div class="row" style="color: #ced2d5; background-color: #1e2b34; font-size: 10px; font-family: opensans, sans-serif; -webkit-font-smoothing: antialiasing; margin: 0px">'+
                ''+
                '</div>'
            );

            // Listener Handlers for Trade Actions
            var onInstrumentUpdate =
                function (instrument) {
                    // ToDo: Refactor this function
                    for (var i = 0; i < document.getElementsByName("BASE_CURRENCY").length; i++) {
                        document.getElementsByName("BASE_CURRENCY")[i].innerHTML = instrument.base;
                    }
                };
            var onBalanceUpdate =
                function (balance) {
                    $('#quoted_available').text(balance.quote.available.toFixed(4));
                    $('#quoted_hold').text(balance.quote.hold.toFixed(4));
                    $('#base_available').text(balance.base.available.toFixed(4));
                    $('#base_hold').text(balance.base.hold.toFixed(4));

                    // TODO: This is a crude way of calculating current account value...
                    var top_ask_price = parseFloat($('#ap9').text());
                    var account_value = balance.quote.available + balance.quote.hold + (balance.base.available * top_ask_price) + (balance.base.hold * top_ask_price);
                    $('#account_value').text(account_value.toFixed(4));
                };

            goldenDash.eventHub.on('instrument_update', onInstrumentUpdate, this);
            goldenDash.eventHub.on('balance_update', onBalanceUpdate, this);


            // Add button handlerso
            var addButtonHandlers =
                function () {
                    // Buttons that interact with the Click Trader Directly
                    $('#cancel_session').on('click',
                        function(e) {
                            goldenDash.eventHub.emit('click_trader_message', JSON.stringify({ 'cancel_session': {} }));
                        })


                    $('#limit_order_button').on('click', function(e) {
                        const price = parseFloat($('#limit_price').val());
                        const qty = parseFloat($('#limit_amount').val());
                        const time_in_force = $('#limit_tif input:checked').val();
                        const ioc = (time_in_force == 'IOC') ? true : false;
                        const quote = (time_in_force == 'IOC') ? false : true;

                        var message =
                            {
                                'submit': {
                                    'price': price,
                                    'qty': qty,
                                    'side': time_in_force,
                                    'ioc': ioc,
                                    'quote': quote
                                }
                            };

                        goldenDash.eventHub.emit('click_trader_message', JSON.stringify(message));
                    });

                    $('#cancel_all').on('click',
                        function(e) {
                            goldenDash.eventHub.emit('click_trader_message', JSON.stringify({ 'cancel_all': {} }));
                        });

                    // Buttons that change the GUI interface
                    $('#account_value').on('click', function(e) {
                        // TODO: Crude calculations - need to find a better approach
                        var top_ask_price = parseFloat($('#ap9').text());
                        var account_value = parseFloat($('#quoted_available').text()) + parseFloat($('#quoted_hold').text()) + (parseFloat($('#base_available').text()) * top_ask_price) + (parseFloat($('#base_hold').text()) * top_ask_price);
                        $('#account_value').text(account_value.toFixed(4));
                    });
                };

            setTimeout(addButtonHandlers, 100);
        };

        var depthFeedComponent = function(container, state) {
            // Check for local storage
            if (!typeof window.localStorage) {
                return;
            }

            // ToDo: Refactor this into seperate HTML chunks

            container.getElement().append(
                '<div class="row" id="depth_feed" style="color: #ced2d5; background-color: #1e2b34; font-size: 10px; font-family: opensans, sans-serif; -webkit-font-smoothing: antialiasing;">'+
                '    <div class="col-md-12">'+
                '        <table id="depth" style="font-size: 11px; color: white; width: 450px; border-bottom: 2px solid #2f3c44; height: 30px;">'+
                '            <col width="60"> <col width="100"> <col width="80"> <col width="100"> <col width="60"> <col width="50">'+
                '                <tr>'+
                '                     <th style="text-align: right;">Orders</th>'+
                '                     <th style="text-align: right;">Quantity</th>'+
                '                     <th style="text-align: center;">Price</th>'+
                '                     <th>Quantity</th>'+
                '                     <th>Orders</th>'+
                '                     <th style="text-left: right">Delta</th>'+
                '                 </tr>'+
                '        </table>'+
                '    </div>'+
                '    <div class="col-md-12" style="overflow: scroll; height: '+(2*(feed_depth+1)*row_size + 15)+'px;" id="depth_feed_table">'+
                '        <table id="asks" style="color: white; width: 450px;">'+
                '            <col width="60"> <col width="100"> <col width="80"> <col width="100"> <col width="60"> <col width="50">'+
                '        </table>'+
                '        <table id="spread" style="border-top: 1px solid #2f3c44; border-bottom: 1px solid #2f3c44; color: white; width: 450px; height: 25px;">'+
                '            <col width="60"> <col width="100"> <col width="80"> <col width="100"> <col width="60"> <col width="50">'+
                '        </table>'+
                '        <table id="bids" style="color: white; width: 450px;">'+
                '            <col width="60"> <col width="100"> <col width="80"> <col width="100"> <col width="60"> <col width="50">'+
                '        </table>'+
                '    </div>'+
                '</div>'
            );
            // Need to resize the height of the depth feed on resize of window to make sure scroll works
            $(window).on('resize', function() { $('#depth_feed_table').css('height', getHeight()); });


            // Initialize the Depth Feed - creates the base html and adds on click handlers
            var initDepthFeed =
                function () {
                    init_depth_feed(feed_depth);

                    for(var i = 0; i < feed_depth; ++i)
                    {
                        $('#ap'+i).on('click', function(e) {
                            var price = $('#'+e.target.id).text();
                            $('#limit_price').val(parseFloat(price));
                            $('#Side2').prop("checked", true);
                        });
                        $('#bp'+i).on('click', function(e) {
                            var price = $('#'+e.target.id).text();
                            $('#limit_price').val(parseFloat(price));
                            $('#Side1').prop("checked", true);
                        });

                        $('#aq'+i).on('click', function(e) {
                            var quantity = $('#'+e.target.id).text();
                            $('#limit_amount').val(parseFloat(quantity));
                            $('#Side2').prop("checked", true);
                        });
                        $('#bq'+i).on('click', function(e) {
                            var quantity = $('#'+e.target.id).text();
                            $('#limit_amount').val(parseFloat(quantity));
                            $('#Side1').prop("checked", true);
                        });
                    }
                };

            setTimeout(initDepthFeed, 100);

            var onBookUpdate =
                function (book, feed_depth) {
                    update_depth_feed(book, feed_depth);
                };

            goldenDash.eventHub.on('book', onBookUpdate, this);
        };

        var tradeHistoryComponent = function(container, state) {
            // Check for local storage
            if (!typeof window.localStorage) {
                return;
            }

            // TODO: Use CSS for this
            const trade_history_row = $('<div class="row" id="trade_history" style="color: #ced2d5; background-color: #1e2b34; font-size: 10px; font-family: opensans, sans-serif; -webkit-font-smoothing: antialiasing;"></div>');
            const table_header = $('<div class="col-md-12">'+
                                   '    <table style="font-size: 11px; color: white; width: 195px; border-bottom: 2px solid #2f3c44; height: 30px;">'+
                                   '        <col width="50"> <col width="70"> <col width="45">'+
                                   '            <tr>'+
                                   '                <th style="text-align: right;">Price</th>'+
                                   '                <th style="text-align: center;">Qty</th>'+
                                   '                <th style="text-align: left;">Time</th>'+
                                   '            </tr>'+
                                   '    </table>'+
                                   '</div>');
            const tableBody = $('<div class="col-md-12" style="overflow: scroll;">'+
                                '    <table id="trade_history_table" style="color: white; width: 195px;">'+
                                '        <col width="50"> <col width="70"> <col width="45">'+
                                '    </table>'+
                                '</div>');

            trade_history_row.append(table_header);
            trade_history_row.append(tableBody);

            container.getElement().append(trade_history_row);

            const MAX_NUM_TRADES_TO_DISPLAY = 100;
            var num_trades_displayed = 0;

            var displayTrades =
                function(trades) {
                    for (var i = 0; i < trades.length; i++) {
                        ++num_trades_displayed;

                        const trade = trades[i];

                        const price_color = (trade.aggressor == 'Side.BID') ? colors.price.bids : colors.price.asks;

                        const price = parseFloat(trade.price).toFixed(2);
                        const qty = parseFloat(trade.qty).toFixed(6);

                        const time_color = '#777f85';
                        var time = new Date();
                        const pretty_time = ("0"+time.getHours()).slice(-2)+":"+("0"+time.getMinutes()).slice(-2)+":"+("0"+time.getSeconds()).slice(-2);

                        $('#trade_history_table').prepend(
                            '<tr>'+
                            '    <td style="text-align: right; color:'+price_color+'; font-weight:">'+price+'</td>' +
                            '    <td style="text-align: center;">'+qty+'</td>' +
                            '    <td style="text-align: left; color: '+time_color+';">'+pretty_time+'</td>' +
                            '</tr>'
                        );
                    }

                    while (num_trades_displayed > MAX_NUM_TRADES_TO_DISPLAY) {
                        var table = document.getElementById('trade_history_table');
                        table.deleteRow(num_trades_displayed - 1);
                        --num_trades_displayed;
                    }
                };

            goldenDash.eventHub.on('trades', displayTrades);
        }

        var messagingComponent = function(container, state) {
            // Check for local storage
            if (!typeof window.localStorage) {
                return;
            }

            var tab_btn_container = $('<div class="tab-btn-first"></div>');
            var refresh_button = $('<button class="btn btn-default btn-xs smfont" title="Trim Messages"><span class="glyphicon glyphicon-scissors"></span></button>');
            refresh_button.click(
                function() {
                    $("#messaging_table").find('tbody').find('tr').slice(20).remove();
                }
            );
            tab_btn_container.append(refresh_button);

            // Add the refresh button whenever a tab is created
            container.on( 'tab', function( tab ){
                tab.element.append( tab_btn_container );
            });

            container.getElement().append(
                '<div class="row" id="messaging" style="color: #ced2d5; background-color: #1e2b34; font-size: 10px; font-family: opensans, sans-serif; -webkit-font-smoothing: antialiasing;">'+
                '    <div class="col-md-12">'+
                '        <table style="font-size: 11px; color: white; width: 100%;  border-bottom: 2px solid #2f3c44; height: 30px;">'+
                '            <col width="125"> <col width="100"> <col>'+
                '            <tr>'+
                '                <th style="text-align: center;">TimeStamp</th>'+
                '                <th style="text-align: center;">Type</th>'+
                '                <th style="text-align: left;">Msg</th>'+
                '            </tr>'+
                '        </table>'+
                '    </div>'+
                '    <div class="col-md-12" style="overflow: scroll;">'+
                '        <table id="messaging_table" style="color: white; width: 100%;">'+
                '            <col width="125"> <col width="100"> <col>'+
                '        </table>'+
                '    </div>'+
                '</div>'
            );

            var displayMessages =
                function (actions) {
                    const time_stamp = (new Date).toISOString().replace(/z|t/gi,' ').trim();

                    var color = '#ced2d5';
                    var translated_message = ""
                    switch(actions.msg_type) {
                        case 'submit':
                            var s = actions.msg.submit;
                            translated_message = "Price: " + s['price'] + " | Qty: " + s.qty + " | Side: " + s.side + " | IOC: " + s.ioc + " | Quote: " + s.quote;
                            break;
                        case 'submit_ack':
                        case 'on_complete':
                            color = colors.logging.good;
                            var a = actions.msg;
                            translated_message = "Price: " + a.price + " | Side: " + a.side + " | Rem Qty: " + a.remaining_qty + " | OrderID: " + a.order_id;
                            break;
                        case 'submit_nack':
                        case 'limit_error':
                        case 'internal_nack':
                        case 'order_error':
                        case 'cancel_nack':
                        case 'cancel_all_nack':
                            color = colors.logging.bad;
                            var e = actions.msg;
                            translated_message = "Error: " + e.error + " | Trigger: " + e.trigger.msg + " | Args: " + JSON.stringify(e.trigger.args);
                            break;
                        case 'on_fill':
                            color = colors.logging.good;
                            var f = actions.msg;
                            translated_message = "Filled Qty: " + f.filled_qty + " | Order - Price: " + f.order.price + " - Side: " + f.order.side + " - Rem Qty: " + f.order.remaining_qty + " - OrderID: " + f.order.order_id;
                            break;
                        case 'open_orders':
                            var pending = 0;
                            var open = 0;
                            var active = 0;
                            for (var i in actions.msg) {
                                if (actions.msg[i]['status'] == 'pending') { ++pending; }
                                else if (actions.msg[i]['status'] == 'open') { ++open; }
                                else if (actions.msg[i]['status'] == 'active') { ++active; }
                            }
                            translated_message = "Open Orders: " + actions.msg.length + " | Open: " + open + " | Pending: " + pending + " | active: " + active;
                            break;
                        case 'fills':
                            translated_message = "Fills found: " + actions.msg.length;
                            break;
                        default:
                            translated_message = "Unhandled Msg: " + JSON.stringify(actions);
                            break;
                    }

                    $('#messaging_table').prepend(
                        '<tr>'+
                        '    <td style="text-align: right;">'+time_stamp+'</td>' +
                        '    <td style="color: '+color+'; padding-left: 10px; text-align: left;">'+actions.msg_type+'</td>' +
                        '    <td style="text-align: left;">'+translated_message+'</td>' +
                        '</tr>'
                    );
                };

            goldenDash.eventHub.on('messages', displayMessages);
        };

        var openOrdersComponent = function(container, state) {
             // Check for local storage
            if (!typeof window.localStorage) {
                return;
            }

            var counter = $('<div class="messageCounter smfont">Total: 0<div>');
            var tab_btn_container = $('<div class="tab-btn-first"></div>');
            var refresh_button = $('<button class="btn btn-default btn-xs smfont" title="Refresh"><span class="glyphicon glyphicon-transfer"></span></button>');
            refresh_button.click(
                function() {
                    goldenDash.eventHub.emit('click_trader_message', '{"admin": "ListOrders"}');
                }
            );
            tab_btn_container.append(refresh_button);

            // Add the counter element and refresh button whenever a tab is created
            container.on( 'tab', function( tab ){
                tab.element.append( counter );
                tab.element.append( tab_btn_container );
            });

            container.getElement().append(
                '<div class="row" style="color: #ced2d5; background-color: #1e2b34; font-size: 10px; font-family: opensans, sans-serif; -webkit-font-smoothing: antialiasing;">'+
                '    <div class="col-md-12">'+
                '        <table style="width: 100%; margin-left: 10px; margin-right: 10px;">'+
                '            <thead >'+
                '                <tr style="font-size: 11px; font-weight: bold; border-bottom: 2px solid #2f3c44; height: 30px;">'+
                '                    <th>Product</th>'+
                '                    <th>Size</th>'+
                '                    <th>Filled</th>'+
                '                    <th>Price</th>'+
                '                    <th>Fees</th>'+
                '                    <th>Time</th>'+
                '                    <th>Status</th>'+
                '                    <th>Executed Value</th>'+
                '                    <th>TIF</th>'+
                '                    <th>Type</th>'+
                '                    <th>Post Only</th>'+
                '                    <th>Settled</th>'+
                '                </tr>'+
                '            </thead>'+
                '            <tbody id="open_orders_table" style="font-weight: normal;">'+
                '            </tbody>'+
                '        </table>'+
                '    </div>'+
                '    </div>'+
                '</div>'
            );

            var onOpenOrders =
                function (open_orders) {
                    const messages = open_orders.msg;

                    // Update the counter button at the top
                    counter.text('Total: ' + messages.length);

                    // Update the table display
                    $('#open_orders_table').html("");

                    for (var i in messages) {
                        const order = messages[i];

                        // Style
                        const price_color = (order['side'] == 'buy') ? colors.price.bids : colors.price.asks;
                        const fees_color = (parseFloat(order['fees']) > 0.0) ? colors.logging.bad : '#ced2d5';

                        // Message Values
                        const size = parseFloat(order['size']).toFixed(4);
                        const filled_size = parseFloat(order['filled_size']).toFixed(4);
                        const price = parseFloat(order['price']).toFixed(4);
                        const filled_fees = parseFloat(order['fill_fees']).toFixed(4);
                        const executed_value = parseFloat(order['executed_value']).toFixed(4);

                        $('#open_orders_table').append(
                            '<tr id="'+order['id']+'">'+
                            '    <td>'+order['product_id']+'</td>'+
                            '    <td>'+size+'</td>'+
                            '    <td>'+filled_size+'</td>'+
                            '    <td style="color: '+price_color+'">'+price+'</td>'+
                            '    <td style="color: '+fees_color+'">'+filled_fees+'</td>'+
                            '    <td>'+order['created_at']+'</td>'+
                            '    <td>'+order['status']+'</td>'+
                            '    <td>'+executed_value+'</td>'+
                            '    <td>'+order['time_in_force']+'</td>'+
                            '    <td>'+order['type']+'</td>'+
                            '    <td>'+order['post_only']+'</td>'+
                            '    <td>'+order['settled']+'</td>'+
                            '</tr>'
                        );
                    }
                };

            goldenDash.eventHub.on('open_orders', onOpenOrders);
        };

        var fillsComponent = function(container, state) {
             // Check for local storage
            if (!typeof window.localStorage) {
                return;
            }

            var tab_btn_container = $('<div class="tab-btn-first"></div>');
            var refresh_button = $('<button class="btn btn-default btn-xs smfont" title="Refresh"><span class="glyphicon glyphicon-transfer"></span></button>');
            refresh_button.click(
                function() {
                    goldenDash.eventHub.emit('click_trader_message', '{"admin": "GetFills"}');
                }
            );
            tab_btn_container.append(refresh_button);

            // Add the refresh button whenever a tab is created
            container.on( 'tab', function( tab ){
                tab.element.append( tab_btn_container );
            });

            container.getElement().append(
                '<div class="row" style="color: #ced2d5; background-color: #1e2b34; font-size: 10px; font-family: opensans, sans-serif; -webkit-font-smoothing: antialiasing;">'+
                '    <div class="col-md-12">'+
                '        <table style="width: 100%; margin-left: 5px; marginn-right: 5px;">'+
                '            <thead >'+
                '                <tr style="font-size: 11px; font-weight: bold; border-bottom: 2px solid #2f3c44; height: 30px;">'+
                '                    <th>Product</th>'+
                '                    <th>Size</th>'+
                '                    <th>Price</th>'+
                '                    <th>Fees</th>'+
                '                    <th>Time</th>'+
                '                    <th>Settled</th>'+
                '                    <th>Cost</th>'+
                '                </tr>'+
                '            </thead>'+
                '            <tbody id="fills_table" style="font-weight: normal;">'+
                '            </tbody>'+
                '        </table>'+
                '    </div>'+
                '    </div>'+
                '</div>'
            );

            var onFills =
                function (actions) {
                    actions.msg.sort(
                        function(a,b){
                            return new Date(a['created_at']) - new Date(b['created_at']);
                        }
                    );

                    for (var i in actions.msg) {
                        const fill = actions.msg[i];

                        const price_color = (fill['side'] == 'buy') ? colors.price.bids : colors.price.asks;
                        const fees_color = (parseFloat(fill['fee']) > 0.0) ? colors.logging.bad : '#ced2d5';

                        const size = parseFloat(fill['size']).toFixed(4);
                        const price = parseFloat(fill['price']).toFixed(4);
                        const fee = parseFloat(fill['fee']).toFixed(4);
                        const cost = (parseFloat(fill['price'])*parseFloat(fill['size']) + parseFloat(fill['fee'])).toFixed(4);
                        $('#fills_table').prepend(
                            '<tr id="'+fill['order_id']+'">'+
                            '    <td>'+fill['product_id']+'</td>'+
                            '    <td>'+size+'</td>'+
                            '    <td style="color: '+price_color+'">'+price+'</td>'+
                            '    <td style="color: '+fees_color+'">'+fee+'</td>'+
                            '    <td>'+fill['created_at']+'</td>'+
                            '    <td>'+fill['settled']+'</td>'+
                            '    <td>'+cost+'</td>'+
                            '</tr>'
                        );
                    }
                };

            goldenDash.eventHub.on('fills', onFills);

        };

        var anchorStrategyComponent = function(container, state) {
            // Check for local storage
            if (!typeof window.localStorage) {
                return;
            }

            container.getElement().append(
                '<div class="row" style="padding-left: 15px; padding-right: 15px; background-color: #1e2b34; font-size: 10px; font-family: opensans, sans-serif; -webkit-font-smoothing: antialiasing;">'+
                '    <div class="col-md-12" style="padding: 0px">'+
                '        <div class="row" style="padding: 0px; margin: 0px">'+
                '             <div class="container" style="width: 950px">'+
                '                 <div class="editor" id="anchor_strategy_state_editor"> </div>'+
                '                 <div class="editor" id="anchor_strategy_params_editor"> </div>'+
                '                 <form class="form-horizontal" style="padding: 0px; margin: 0px;">'+
                '                     <div class="form-inline" style="padding: 0px; margin: 0px;">'+
                '                         <div class="col-md-3" style="padding: 5px; margin: 0px;"><a type="button" id="update_anchor_params" style="margin-top: 10px;"  class="btn btn-sm btn-block btn-default">Update Strategy</a> </div>'+
                '                         <div class="col-md-3" style="padding: 5px; margin: 0px;"> <a type="button" id="fetch_anchor_params" style="margin-top: 10px;"  class="btn btn-sm btn-block btn-primary">Fetch Params</a></div>'+
                '                         <div class="col-md-2" style="padding: 5px; margin: 0px;"> <a type="button" id="start_anchor_strategy" style="margin-top: 10px;"  class="btn btn-sm btn-block btn-success">Start Strategy</a></div>'+
                '                         <div class="col-md-2" style="padding: 5px; margin: 0px;"> <a type="button" id="stop_anchor_strategy" style="margin-top: 10px;"  class="btn btn-sm btn-block btn-danger">Stop Strategy</a></div>'+
                '                         <div class="col-md-2" style="padding: 5px; margin: 0px;"> <a type="button" id="reset_anchor_strategy_reference" style="margin-top: 10px;"  class="btn btn-sm btn-block btn-info">Reset PnL Reference</a></div>'+
                '                     </div>'+
                '                 </form>'+
                '             </div>'+

                '        </div>'+
                '    </div>'+
                '</div>'
            );

            var onStratConfig =
                function (actions) {
                    console.log(actions);
                };


            goldenDash.eventHub.on('anchor_configuration', onStratConfig);

            // Add button handlers
            var addStrategyParamsHandler =
                function (editor) {
                    $('#update_anchor_params').on('click',
                        function(e) {
                            var message = {};
                            message['config'] = editor.getValue();
                            goldenDash.eventHub.emit('to_anchor_strategy', JSON.stringify(message));
                        }
                    );
                    $('#fetch_anchor_params').on('click',
                        function(e) {
                            goldenDash.eventHub.emit("to_anchor_strategy", '{"admin": "GetConfig"}');
                        }
                    );
                    $('#start_anchor_strategy').on('click',
                        function(e) {
                            goldenDash.eventHub.emit("to_anchor_strategy", '{"admin": "StartStrategy"}');
                        }
                    );
                    $('#stop_anchor_strategy').on('click',
                        function(e) {
                            goldenDash.eventHub.emit("to_anchor_strategy", '{"admin": "StopStrategy"}');
                        }
                    );
                    $('#reset_anchor_strategy_reference').on('click',
                        function(e) {
                            goldenDash.eventHub.emit("to_anchor_strategy", '{"admin": "ResetPnLReference"}');
                        }
                    );
                };

            var addJsonEditor =
                function () {
                    var strategy_state_startval = {
                        "mkt_price": 0.00,
                        "strategy": 0.00,
                        "starting": 0.00,
                        "cash": 0.0,
                        "crypto": 0.00,
                        "portfolio": 0.00,
                        "state": "#ecf0f1",
                        "net": 0.00,
                        "quote": 0.00,
                        "base": 0,
                        "num_traded": 0,
                        "traded_qty": 0
                    };
                    var anchor_strategy_state_element = document.getElementById('anchor_strategy_state_editor');
                    var strategy_state_options =
                            {
                                  schema: {
                                      format: "grid",
                                      title: "State",
                                      type: "object",
                                      properties: {
                                          mkt_price: { "title": "Mkt Price", "type": "number", "propertyOrder": 6},
                                          strategy: { "title": "Strategy", "type": "number", "propertyOrder": 1},
                                          starting: { "title": "Starting", "type": "number", "propertyOrder": 2},
                                          cash: { "title": "If 100% Cash", "type": "number", "propertyOrder": 3},
                                          crypto: { "title": "If 100% Crypto", "type": "number", "propertyOrder": 4},
                                          portfolio: { "title": "Portfolio Value", "type": "number", "propertyOrder": 5},
                                          state: {"title": "State", "type": "string", "format": "color", "propertyOrder": 7},
                                          net: { "title": "Net PnL", "type": "number", "propertyOrder": 8},
                                          quote: { "title": "USD", "type": "number", "propertyOrder": 9},
                                          base: { "title": "Crypto", "type": "number", "propertyOrder": 10},
                                          num_traded: { "title": "Num Trades", "type": "number", "propertyOrder": 11},
                                          traded_qty: { "title": "Traded Qty", "type": "number", "propertyOrder": 12}
                                      }
                                  },
                                 theme: "bootstrap3",
                                 iconlib: "bootstrap3",
                                 startval: strategy_state_startval,
                                 disable_collapse: true,
                                 disable_properties: true,
                                 disable_array_reorder: true,
                                 disable_array_add: true,
                                 disable_array_delete: true,
                                 disable_array_delete_all_rows: true,
                                 disable_array_delete_last_row: true,
                                 display_required_only: true,
                                 form_name_root: "Anchor State"
                             };


                    var strategy_state = new JSONEditor(anchor_strategy_state_element, strategy_state_options);
                    strategy_state.disable();

                    var strategy_params_startval = {
                        "low": 0,
                        "high": 0,
                        "orders": 0,
                        "show": 0,
                        "slack": 0,
                        "md_refresh": 0,
                        "state_refresh": 0,
                        "change_crypto": 0,
                        "change_cash": 0,
                        "last_update": "Strategy not connected..."
                    };

                    var anchor_strategy_params_element = document.getElementById('anchor_strategy_params_editor');
                    var strategy_params_options =
                            {
                                  schema: {
                                      format: "grid",
                                      title: "Parameters",
                                      type: "object",
                                      properties: {
                                          low: { "title": "Low Price", "type": "number", "propertyOrder": 1 },
                                          high: { "title": "High Price", "type": "number", "propertyOrder": 2 },
                                          orders: { "title": "Num Orders", "type": "number", "propertyOrder": 3},
                                          show: { "title": "Num Show", "type": "number", "propertyOrder": 4},
                                          md_refresh: {"title": "MD Refresh Interval", "type": "number", "propertyOrder": 5},
                                          state_refresh: {"title": "State Refresh Interval", "type": "number", "propertyOrder": 6},
                                          slack: { "title": "Slack", "type": "number", "propertyOrder": 7},
                                          change_crypto: {"title": "Add/Remove Crypto", "type": "number", "propertyOrder": 8},
                                          change_cash: {"title": "Add/Remove Cash", "type": "number", "propertyOrder": 9},
                                          last_update: { "title": "Last Updated", "type": "string", "propertyOrder": 10}
                                      }
                                  },
                                 theme: "bootstrap3",
                                 iconlib: "bootstrap3",
                                 startval: strategy_params_startval,
                                 disable_collapse: true,
                                 disable_properties: true,
                                 disable_array_reorder: true,
                                 disable_array_add: true,
                                 disable_array_delete: true,
                                 disable_array_delete_all_rows: true,
                                 disable_array_delete_last_row: true,
                                 display_required_only: true,
                                 form_name_root: "Anchor Params"
                             };

                    var strategy_params = new JSONEditor(anchor_strategy_params_element, strategy_params_options);

                    var onMessage =
                        function(data) {
                            try {
                                if (data.hasOwnProperty('update')) {
                                    switch(data.update.type) {
                                        case 'PnL':
                                            strategy_state.setValue(JSON.parse(data.update.msg));
                                            break;
                                        case 'Parameters':
                                            strategy_params.setValue(JSON.parse(data.update.msg));
                                            break;
                                    }
                                } else {
                                    console.log("Unhandled message "+data);
                                }
                            } catch (err) {
                                console.log(msg);
                                console.log(err);
                            }
                        };

                    goldenDash.eventHub.on("from_anchor_strategy", onMessage);
                    goldenDash.eventHub.emit("to_anchor_strategy", '{"admin": "GetConfig"}');
                    setTimeout(function() { addStrategyParamsHandler(strategy_params); }, 100);
                };

            setTimeout(addJsonEditor, 100);
        };

        goldenDash.registerComponent('trade_actions', tradeActionsComponent);
        goldenDash.registerComponent('depth_feed', depthFeedComponent);
        goldenDash.registerComponent('signals', function(container, state) {});
        goldenDash.registerComponent('trade_history', tradeHistoryComponent);
        goldenDash.registerComponent('messaging', messagingComponent);
        goldenDash.registerComponent('open_orders', openOrdersComponent);
        goldenDash.registerComponent('fills', fillsComponent);
        goldenDash.registerComponent('anchor_strategy', anchorStrategyComponent);

        goldenDash.init();

        // Data Emitters:
        var anchorStrategyConnect =
            function() {
                var webSocketUri = (window.location.protocol=='https:'&&'wss://'||'ws://')+"0.0.0.0:8010"+'/ws';
                console.log(webSocketUri);
                var ws = new WebSocket(webSocketUri);

                ws.onopen = function () {
                    ws.send('{"admin": "GetConfig"}');
                    goldenDash.eventHub.emit('socket_open', 'AnchorStrategy');
                };

                ws.onmessage = function (msg) {
                    try {
                        var data = JSON.parse(msg.data);
                        goldenDash.eventHub.emit('from_anchor_strategy', data);
                    }
                    catch (err) {
                        console.log(err);
                    };
                };

                ws.onclose =
                    function () {
                        // ToDo: Make use of this broadcast
                        goldenDash.eventHub.emit('socket_closed', 'AnchorStrategy');

                        console.log("AnchorStrategy Closed!");
                        setTimeout(
                            function() {
                                anchorStrategyConnect();
                            }, 5000);
                    };

                var onMessageToAnchorStrategy =
                    function (message) {
                        ws.send(message);
                    };

                goldenDash.eventHub.on('to_anchor_strategy', onMessageToAnchorStrategy);
            };

        var clickTraderConnect =
            function() {
                var webSocketUri = (window.location.protocol=='https:'&&'wss://'||'ws://')+"0.0.0.0:8003"+'/ws';
                var ws = new WebSocket(webSocketUri);

                ws.onopen = function () {
                    ws.send('{"admin": "GetBalance"}');
                    ws.send('{"admin": "ListOrders"}');
                    ws.send('{"admin": "GetFills"}');

                    // TODO: Make use of this broadcast
                    goldenDash.eventHub.emit('socket_open', 'ClickTrader');
                };

                ws.onmessage = function (msg) {
                    try {
                        var data = JSON.parse(msg.data);
                        if (data.hasOwnProperty('balance'))
                        {
                            goldenDash.eventHub.emit('balance_update', data.balance);
                            goldenDash.eventHub.emit('instrument_update', data.instrument);
                        } else if (data.hasOwnProperty('actions')) {
                            var data = JSON.parse(msg.data);
                            if (data.actions.msg_type == 'balance') {
                                goldenDash.eventHub.emit('balance_update', data.actions.msg);
                            } else {
                                goldenDash.eventHub.emit('messages', data.actions);

                                switch(data.actions.msg_type) {
                                    case 'open_orders':
                                        goldenDash.eventHub.emit('open_orders', data.actions);
                                        break;
                                    case 'fills':
                                        goldenDash.eventHub.emit('fills', data.actions);
                                        break;
                                    default:
                                        break;
                                };
                            }
                        } else {
                            var data = JSON.parse(msg.data);
                            console.log("Unhandled message over socket.");
                            console.log(data);
                        }
                    }
                    catch (err) {
                        console.log(err);
                    };
                };

                ws.onclose =
                    function () {
                        // ToDo: Make use of this broadcast
                        goldenDash.eventHub.emit('socket_closed', 'ClickTrader');

                        console.log("Closed!");
                        setTimeout(
                            function() {
                                clickTraderConnect();
                            }, 5000);
                    };

                var onMessageToClickTrader =
                    function (message) {
                        ws.send(message);
                    };

                goldenDash.eventHub.on('click_trader_message', onMessageToClickTrader);

            };

        var depthFeedConnect =
            function() {
                var webSocketUri = (window.location.protocol=='https:'&&'wss://'||'ws://')+"0.0.0.0:8001"+'/ws';

                var ws = new WebSocket(webSocketUri);

                ws.onopen = function () {
                    // TODO: remove this and make sure nothing depends on it
                    set_conn_status(true);

                    // TODO: Make use of this broadcast
                    goldenDash.eventHub.emit('socket_open', 'DepthFeed');
                };

                ws.onmessage = function (msg) {
                    try {
                        var data = JSON.parse(msg.data);
                        var trades = data.book_update.trades;
                        goldenDash.eventHub.emit('trades', trades);

                        if (data.hasOwnProperty('book_update'))
                        {
                            try {
                                goldenDash.eventHub.emit('book', data.book_update.book, feed_depth);
                                //update_depth_feed(data.book_update.book, feed_depth);
                            } catch (err) {
                                console.log("Failed to render visualization properly.");
                                console.log(err);
                            }
                        } else if (data.hasOwnProperty('ws_msg')) {
                            // Ignoring these messages for now
                        } else {
                            console.log('Recieved unhandled msg');
                        }
                    }
                    catch (err) {
                        console.log(msg);
                        console.log(err);
                    };
                };

                ws.onclose = function () {
                    // ToDo: Make use of this broadcast
                    goldenDash.eventHub.emit('socket_closed', 'DepthFeed');

                    console.log("Closed!");

                    // TODO: Remove
                    set_conn_status(false);
                    setTimeout(
                        function() {
                            depthFeedConnect();
                        }, 5000);
                };

            };

        depthFeedConnect();
        clickTraderConnect();
        anchorStrategyConnect();

    </script>
</html>
